stages:
  - build
  - test
  - synthesis
  - program
  - docs

variables:
  XILINX_VIVADO: /non-free/Xilinx/Vivado/2020.2
  CI_REGISTRY: mohs.dhcp.lbl.gov
  IMAGE_BASE: bedrock_testing_base
  IMAGE_VARIANT: bookworm
  DEFAULT_IMAGE: ${CI_REGISTRY}/${IMAGE_BASE}_${IMAGE_VARIANT}
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  FF_SCRIPT_SECTIONS: "true"

# default image if no other specified
image: $DEFAULT_IMAGE:$CI_COMMIT_REF_NAME

# build matrix for docker image generation
.build-matrix:
  variables:
    IMAGE: ${CI_REGISTRY}/${IMAGE_BASE}_${IMAGE_VARIANT}
  parallel:
    matrix:
      - IMAGE_VARIANT: bookworm
      - IMAGE_VARIANT: trixie
  rules:
    - if: '$IMAGE_VARIANT =~ /.*trixie$/ && $CI_JOB_NAME =~ /^oscope.*$/'
      allow_failure: true
    - when: always

include:
  - local: .gitlab/ci/badger.gitlab-ci.yml
  - local: .gitlab/ci/build.gitlab-ci.yml
  - local: .gitlab/ci/board_support.gitlab-ci.yml
  - local: .gitlab/ci/docs.gitlab-ci.yml
  - local: .gitlab/ci/serial_io.gitlab-ci.yml
  - local: .gitlab/ci/other_hdl.gitlab-ci.yml
  - local: .gitlab/ci/soc.gitlab-ci.yml
  - local: .gitlab/ci/oscope.gitlab-ci.yml
  - local: .gitlab/ci/cmoc.gitlab-ci.yml
  - local: .gitlab/ci/comms_top.gitlab-ci.yml
  - local: .gitlab/ci/dsp.gitlab-ci.yml
  - local: .gitlab/ci/marble_family.gitlab-ci.yml
  - local: .gitlab/ci/swap_gitid.gitlab-ci.yml
  - local: .gitlab/ci/cdc_check.gitlab-ci.yml
  - local: .gitlab/ci/localbus.gitlab-ci.yml
  - local: .gitlab/ci/ctrace.gitlab-ci.yml
  - local: .gitlab/ci/leep.gitlab-ci.yml

leep_test:
  extends: .build-matrix
  image: $IMAGE
  stage: test
  script:
    - cd projects/common && PYTHONPATH=../../build-tools python3 -m unittest -v

flake8:
  extends: .build-matrix
  image: $IMAGE
  stage: test
  script:
    - find . -name "*.py" -exec flake8 {} +
