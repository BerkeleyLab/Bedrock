
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>build-tools newad &#8212; Bedrock  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="dsp README" href="../dsp/README_md.html" />
    <link rel="prev" title="build-tools makefile" href="makefile_md.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This documentation is a work in progress.
Expect to see errors and unfinished things.</p>
</div>
<section id="build-tools-newad">
<span id="newad"></span><h1>build-tools newad<a class="headerlink" href="#build-tools-newad" title="Permalink to this heading">¶</a></h1>
<section id="newad-documentation">
<h2>newad Documentation<a class="headerlink" href="#newad-documentation" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">newad.py</span></code> is a python script used for automatic address generation and port assignments. The main goal is to hide the complexity of dealing with registers inside FPGA and reduce the boilerplate code.</p>
<p>The output (therefore functionality) of <code class="docutils literal notranslate"><span class="pre">newad.py</span></code> can be changed depending on how it is called from the CLI.</p>
<p>The ports on the input verilog file can be marked as a register on the final address map. The marking is done by adding <code class="docutils literal notranslate"><span class="pre">external</span></code> comment. Additional properties of the given register can be indicated to the newad by extending the ‘external comment with additional arguments.</p>
<p>Users can call newad with -h option to see all of its arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">newad</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="n">INPUT_FILE</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="n">OUTPUT</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span> <span class="n">DIR_LIST</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span> <span class="n">ADDR_MAP_HEADER</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">r</span> <span class="n">REGMAP</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">l</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">pl</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">w</span> <span class="n">LB_WIDTH</span><span class="p">]</span>
                <span class="p">[</span><span class="o">-</span><span class="n">b</span> <span class="n">BASE_ADDR</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="n">CLK_PREFIX</span><span class="p">]</span>

<span class="n">Automatic</span> <span class="n">address</span> <span class="n">generator</span><span class="p">:</span> <span class="n">Parses</span> <span class="n">verilog</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">generates</span> <span class="n">addresses</span> <span class="ow">and</span> <span class="n">decoders</span> <span class="k">for</span> <span class="n">registers</span> <span class="n">declared</span> <span class="n">external</span> <span class="n">across</span> <span class="n">module</span>
<span class="n">instantiations</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">i</span> <span class="n">INPUT_FILE</span><span class="p">,</span> <span class="o">--</span><span class="n">input_file</span> <span class="n">INPUT_FILE</span>
                        <span class="n">A</span> <span class="n">top</span> <span class="n">level</span> <span class="n">file</span> <span class="n">to</span> <span class="n">start</span> <span class="n">the</span> <span class="n">parser</span>
  <span class="o">-</span><span class="n">o</span> <span class="n">OUTPUT</span><span class="p">,</span> <span class="o">--</span><span class="n">output</span> <span class="n">OUTPUT</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">header</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">d</span> <span class="n">DIR_LIST</span><span class="p">,</span> <span class="o">--</span><span class="n">dir_list</span> <span class="n">DIR_LIST</span>
                        <span class="n">A</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">directories</span> <span class="n">to</span> <span class="n">look</span> <span class="k">for</span> <span class="n">verilog</span> <span class="n">source</span> <span class="n">files</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">dir_0</span><span class="o">&gt;</span><span class="p">[,</span><span class="o">&lt;</span><span class="n">dir_1</span><span class="o">&gt;</span><span class="p">]</span><span class="o">*</span>
  <span class="o">-</span><span class="n">a</span> <span class="n">ADDR_MAP_HEADER</span><span class="p">,</span> <span class="o">--</span><span class="n">addr_map_header</span> <span class="n">ADDR_MAP_HEADER</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">address</span> <span class="nb">map</span> <span class="n">header</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">r</span> <span class="n">REGMAP</span><span class="p">,</span> <span class="o">--</span><span class="n">regmap</span> <span class="n">REGMAP</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">address</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">json</span> <span class="nb">format</span>
  <span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="o">--</span><span class="n">low_res</span>         <span class="n">When</span> <span class="ow">not</span> <span class="n">selected</span> <span class="n">generates</span> <span class="n">a</span> <span class="n">seperate</span> <span class="n">address</span> <span class="n">name</span> <span class="k">for</span> <span class="n">each</span>
  <span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="o">--</span><span class="n">gen_mirror</span>      <span class="n">Generates</span> <span class="n">a</span> <span class="n">mirror</span> <span class="n">where</span> <span class="nb">all</span> <span class="n">registers</span> <span class="ow">and</span> <span class="n">register</span> <span class="n">arrays</span> <span class="k">with</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="n">are</span> <span class="n">available</span> <span class="k">for</span> <span class="n">readback</span>
  <span class="o">-</span><span class="n">pl</span><span class="p">,</span> <span class="o">--</span><span class="n">plot_map</span>       <span class="n">Plots</span> <span class="n">the</span> <span class="n">register</span> <span class="nb">map</span> <span class="n">using</span> <span class="n">a</span> <span class="n">broken</span> <span class="n">bar</span> <span class="n">graph</span>
  <span class="o">-</span><span class="n">w</span> <span class="n">LB_WIDTH</span><span class="p">,</span> <span class="o">--</span><span class="n">lb_width</span> <span class="n">LB_WIDTH</span>
                        <span class="n">Set</span> <span class="n">the</span> <span class="n">address</span> <span class="n">width</span> <span class="n">of</span> <span class="n">the</span> <span class="n">local</span> <span class="n">bus</span> <span class="kn">from</span> <span class="nn">which</span> <span class="n">the</span> <span class="n">generated</span> <span class="n">registers</span> <span class="n">are</span> <span class="n">decoded</span>
  <span class="o">-</span><span class="n">b</span> <span class="n">BASE_ADDR</span><span class="p">,</span> <span class="o">--</span><span class="n">base_addr</span> <span class="n">BASE_ADDR</span>
                        <span class="n">Set</span> <span class="n">the</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">register</span> <span class="nb">map</span> <span class="n">to</span> <span class="n">be</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">here</span>
  <span class="o">-</span><span class="n">p</span> <span class="n">CLK_PREFIX</span><span class="p">,</span> <span class="o">--</span><span class="n">clk_prefix</span> <span class="n">CLK_PREFIX</span>
                        <span class="n">Prefix</span> <span class="n">of</span> <span class="n">the</span> <span class="n">clock</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">decoding</span> <span class="ow">is</span> <span class="n">done</span> <span class="p">[</span><span class="n">currently</span> <span class="n">ignored</span><span class="p">],</span> <span class="n">appends</span> <span class="n">_clk</span>
</pre></div>
</div>
<section id="the-workflow-of-newad">
<h3>The workflow of newad<a class="headerlink" href="#the-workflow-of-newad" title="Permalink to this heading">¶</a></h3>
<p>The ‘main’ input to the newad is essentially two arguments. The top verilog file to start the parser and the list of directories to go through.</p>
<p>newad starts by parsing the top file and starts going deeper into the hierarchy. There is two main process is happening during this traverse;</p>
<ol class="arabic simple">
<li><p>Looking for verilog module instantiations marked <code class="docutils literal notranslate"><span class="pre">automatic</span></code>, for which newad needs to generate port assignments. When such an instantiation is found, it calls back itself recursively to look deeper into the hierarchy.</p></li>
</ol>
<p>The following verilog snippet shows how instantiated verilog module is marked <code class="docutils literal notranslate"><span class="pre">auto</span></code> by a developer</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">digitizer_slowread</span><span class="w"> </span><span class="n">digitizer_slowread</span><span class="w"> </span><span class="c1">// auto</span>
<span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">lb_clk</span><span class="p">(</span><span class="n">lb_clk</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">adc_clk</span><span class="p">(</span><span class="n">adc_clk</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">adc_data</span><span class="p">(</span><span class="n">adc_data</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">slow_snap</span><span class="p">(</span><span class="n">slow_snap</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">slow_chain_out</span><span class="p">(</span><span class="n">slow_chain_out</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">slow_read_lb</span><span class="p">(</span><span class="n">slow_read_lb</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">tag_now</span><span class="p">(</span><span class="n">tag_now</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="c1">//`AUTOMATIC_digitizer_slowread</span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>In this example, ports marked with a macro <code class="docutils literal notranslate"><span class="pre">AUTOMATIC_digitizer_slowread</span></code> of this verilog module will be connected by newad generated wires/regs.</p>
<ol class="arabic simple" start="2">
<li><p>Looking for input/output ports labeled ‘external’. Record them in the port_lists dictionary for this module. Searches ports on each line of verilog code by looking at its directionality (while also catching if it is signed or not) and very specific verilog comment describing the other att</p></li>
</ol>
<p>Following verilog snippet shows a single bit register defined as <code class="docutils literal notranslate"><span class="pre">external</span></code> indicating that it should be a register and it has a property of <code class="docutils literal notranslate"><span class="pre">single-cycle</span></code></p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">input</span><span class="w"> </span><span class="n">prc_dds_ph_reset</span><span class="p">,</span><span class="w">  </span><span class="c1">// external single-cycle</span>
</pre></div>
</div>
<section id="register-attributes">
<h4>Register Attributes<a class="headerlink" href="#register-attributes" title="Permalink to this heading">¶</a></h4>
<p>Each port defined as ‘external’ using the comment of verilog, will end up as a register. Users can then attach additional features for this register by adding more attributes:</p>
<p>Below is a list of those additional attributes for a register defined in newad:</p>
<ul class="simple">
<li><p>single-cycle</p></li>
<li><p>strobe</p></li>
<li><p>we-strobe</p></li>
<li><p>plus-we</p></li>
</ul>
<!-- % TODO: explain each of those options and how it changes the output --></section>
</section>
<section id="verilog-header-generation">
<h3>Verilog Header Generation<a class="headerlink" href="#verilog-header-generation" title="Permalink to this heading">¶</a></h3>
<p>when used with <code class="docutils literal notranslate"><span class="pre">-a</span></code> argument, newad creates verilog header containing the address map for given top level object. This file will have the name <code class="docutils literal notranslate"><span class="pre">addr_map_&lt;module_name&gt;.vh</span></code>. Inside the file, newad will place all address decoding for each register.</p>
<p>The following is an example of a decoded register address macro definition.</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="cp">`define ADDR_HIT_digitizer_dsp_real_sim_mux_shell_0_dsp_ff_driver_mem (lb4_addr[0][`LB_HI:11]==4096) </span><span class="c1">// digitizer_dsp bitwidth: 11, base_addr: 8388608</span>
</pre></div>
</div>
<p>When used with <code class="docutils literal notranslate"><span class="pre">-r</span></code> argument, newad creates address map in <code class="docutils literal notranslate"><span class="pre">.json</span></code> format.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Bedrock</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../general-docs.html">General Docs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../general-docs.html#docs">Docs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../badger/README_md.html">badger README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/doc/README_md.html">doc README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/mem_gate_md.html">badger mem_gate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/status_md.html">badger status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/bmb7_kintex/README_md.html">bmb7_kintex README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/zest/README_md.html">zest README</a></li>
<li class="toctree-l3"><a class="reference internal" href="makefile_md.html">build-tools makefile</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">build-tools newad</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#newad-documentation">newad Documentation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dsp/README_md.html">dsp README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fpga_family/xilinx/README_md.html">xilinx README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/CONTRIBUTING_md.html">guidelines CONTRIBUTING</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/rtl_guidelines_md.html">guidelines rtl_guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/i2cbridge/README_md.html">i2cbridge README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/idelay_scanner/README_md.html">idelay_scanner README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/common/README_md.html">common README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/comms_top/README_md.html">comms_top README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/bmb7_cu/README_md.html">bmb7_cu README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/marble_family/README_md.html">marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/test_marble_family/README_md.html">test_marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rtsim/README_md.html">rtsim README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/README_md.html">chitchat README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/chitchat_txrx_wrap_md.html">chitchat chitchat_txrx_wrap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/README_md.html">picorv32 README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/badger_lwip/README_md.html">badger_lwip README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/fv/README_md.html">fv README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/lb_bridge/README_md.html">lb_bridge README</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bedrock-modules.html">Bedrock Modules</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../../general-docs.html">General Docs</a><ul>
      <li>Previous: <a href="makefile_md.html" title="previous chapter">build-tools makefile</a></li>
      <li>Next: <a href="../dsp/README_md.html" title="next chapter">dsp README</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, LBNL ATG.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/_gen_md/build-tools/newad_md.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>