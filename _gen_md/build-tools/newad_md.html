<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>build-tools newad &mdash; Bedrock  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="dsp README" href="../dsp/README_md.html" />
    <link rel="prev" title="build-tools makefile" href="makefile_md.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Bedrock
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../general-docs.html">General Docs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../general-docs.html#docs">Docs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../CONTRIBUTING_md.html">CONTRIBUTING</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/README_md.html">badger README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/doc/README_md.html">doc README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/mem_gate_md.html">badger mem_gate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/status_md.html">badger status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/bmb7_kintex/README_md.html">bmb7_kintex README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/zest/README_md.html">zest README</a></li>
<li class="toctree-l3"><a class="reference internal" href="cdc_snitch_md.html">build-tools cdc_snitch</a></li>
<li class="toctree-l3"><a class="reference internal" href="makefile_md.html">build-tools makefile</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">build-tools newad</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#newad-documentation">newad Documentation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dsp/README_md.html">dsp README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fpga_family/xilinx/README_md.html">xilinx README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/rtl_guidelines_md.html">guidelines rtl_guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../localbus/README_md.html">localbus README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../localbus/jit_rad_md.html">localbus jit_rad</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/i2cbridge/README_md.html">i2cbridge README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/idelay_scanner/README_md.html">idelay_scanner README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/common/README_md.html">common README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/comms_top/README_md.html">comms_top README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/bmb7_cu/README_md.html">bmb7_cu README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/marble_family/README_md.html">marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/test_marble_family/README_md.html">test_marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/test_marble_family/i2c/README_md.html">i2c README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rtsim/README_md.html">rtsim README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/README_md.html">chitchat README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/chitchat_txrx_wrap_md.html">chitchat chitchat_txrx_wrap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/README_md.html">picorv32 README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/badger_lwip/README_md.html">badger_lwip README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/fv/README_md.html">fv README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/lb_bridge/README_md.html">lb_bridge README</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bedrock-modules.html">Bedrock Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rtsim-module.html">RTSIM Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dsp-digaree-module.html">DSP Digaree Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Bedrock</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../general-docs.html">General Docs</a></li>
      <li class="breadcrumb-item active">build-tools newad</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/_gen_md/build-tools/newad_md.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This documentation is a work in progress.
Expect to see errors and unfinished things.</p>
</div>
<section id="build-tools-newad">
<span id="newad"></span><h1>build-tools newad<a class="headerlink" href="#build-tools-newad" title="Permalink to this heading"></a></h1>
<section id="newad-documentation">
<h2>newad Documentation<a class="headerlink" href="#newad-documentation" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">newad.py</span></code> is a python script used to simplify creation of software-settable
registers within Verilog, typically in an FPGA context.  The amount of
boilerplate code required is marginally zero.  In the background, addresses
are generated and bus decoders are created.</p>
<p>The current version is based on “magic comments” (see examples below), which
imposes some limitations on its use. We have hopes to rewrite the system
someday to use Verilog attributes and a Real Verilog parser.</p>
<p>Ports on the input Verilog file can be marked (using an <code class="docutils literal notranslate"><span class="pre">external</span></code> comment)
as a register to show up in the final address map. Some properties of those
registers can be controlled with additional flags in the comment.</p>
<p>The output (therefore functionality) of <code class="docutils literal notranslate"><span class="pre">newad.py</span></code> can be changed depending on
how it is called from the CLI.  These calls are typically buried in a Makefile.
Users can call newad with -h option to see all of its arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">newad</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="n">INPUT_FILE</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="n">OUTPUT</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span> <span class="n">DIR_LIST</span><span class="p">]</span>
                <span class="p">[</span><span class="o">-</span><span class="n">a</span> <span class="n">ADDR_MAP_HEADER</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">r</span> <span class="n">REGMAP</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">l</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">pl</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">w</span> <span class="n">LB_WIDTH</span><span class="p">]</span>
                <span class="p">[</span><span class="o">-</span><span class="n">b</span> <span class="n">BASE_ADDR</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="n">CLK_PREFIX</span><span class="p">]</span>

<span class="n">Automatic</span> <span class="n">address</span> <span class="n">generator</span><span class="p">:</span> <span class="n">Parses</span> <span class="n">Verilog</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">generates</span> <span class="n">addresses</span> <span class="ow">and</span>
<span class="n">decoders</span> <span class="k">for</span> <span class="n">registers</span> <span class="n">declared</span> <span class="n">external</span> <span class="n">across</span> <span class="n">module</span> <span class="n">instantiations</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">i</span> <span class="n">INPUT_FILE</span><span class="p">,</span> <span class="o">--</span><span class="n">input_file</span> <span class="n">INPUT_FILE</span>
                        <span class="n">A</span> <span class="n">top</span> <span class="n">level</span> <span class="n">file</span> <span class="n">to</span> <span class="n">start</span> <span class="n">the</span> <span class="n">parser</span>
  <span class="o">-</span><span class="n">o</span> <span class="n">OUTPUT</span><span class="p">,</span> <span class="o">--</span><span class="n">output</span> <span class="n">OUTPUT</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">header</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">d</span> <span class="n">DIR_LIST</span><span class="p">,</span> <span class="o">--</span><span class="n">dir_list</span> <span class="n">DIR_LIST</span>
                        <span class="n">A</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">directories</span> <span class="n">to</span> <span class="n">look</span> <span class="k">for</span> <span class="n">Verilog</span> <span class="n">source</span> <span class="n">files</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">dir_0</span><span class="o">&gt;</span><span class="p">[,</span><span class="o">&lt;</span><span class="n">dir_1</span><span class="o">&gt;</span><span class="p">]</span><span class="o">*</span>
  <span class="o">-</span><span class="n">a</span> <span class="n">ADDR_MAP_HEADER</span><span class="p">,</span> <span class="o">--</span><span class="n">addr_map_header</span> <span class="n">ADDR_MAP_HEADER</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">address</span> <span class="nb">map</span> <span class="n">header</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">r</span> <span class="n">REGMAP</span><span class="p">,</span> <span class="o">--</span><span class="n">regmap</span> <span class="n">REGMAP</span>
                        <span class="n">Outputs</span> <span class="n">generated</span> <span class="n">address</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">json</span> <span class="nb">format</span>
  <span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="o">--</span><span class="n">low_res</span>         <span class="n">When</span> <span class="ow">not</span> <span class="n">selected</span> <span class="n">generates</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">address</span> <span class="n">name</span> <span class="k">for</span> <span class="n">each</span>
  <span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="o">--</span><span class="n">gen_mirror</span>      <span class="n">Generates</span> <span class="n">a</span> <span class="n">mirror</span> <span class="n">where</span> <span class="nb">all</span> <span class="n">registers</span> <span class="ow">and</span> <span class="n">register</span> <span class="n">arrays</span> <span class="k">with</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="n">are</span> <span class="n">available</span> <span class="k">for</span> <span class="n">readback</span>
  <span class="o">-</span><span class="n">pl</span><span class="p">,</span> <span class="o">--</span><span class="n">plot_map</span>       <span class="n">Plots</span> <span class="n">the</span> <span class="n">register</span> <span class="nb">map</span> <span class="n">using</span> <span class="n">a</span> <span class="n">broken</span> <span class="n">bar</span> <span class="n">graph</span>
  <span class="o">-</span><span class="n">w</span> <span class="n">LB_WIDTH</span><span class="p">,</span> <span class="o">--</span><span class="n">lb_width</span> <span class="n">LB_WIDTH</span>
                        <span class="n">Set</span> <span class="n">the</span> <span class="n">address</span> <span class="n">width</span> <span class="n">of</span> <span class="n">the</span> <span class="n">local</span> <span class="n">bus</span> <span class="kn">from</span><span class="w"> </span><span class="nn">which</span> <span class="n">the</span> <span class="n">generated</span> <span class="n">registers</span> <span class="n">are</span> <span class="n">decoded</span>
  <span class="o">-</span><span class="n">b</span> <span class="n">BASE_ADDR</span><span class="p">,</span> <span class="o">--</span><span class="n">base_addr</span> <span class="n">BASE_ADDR</span>
                        <span class="n">Set</span> <span class="n">the</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">register</span> <span class="nb">map</span> <span class="n">to</span> <span class="n">be</span> <span class="n">generated</span> <span class="kn">from</span><span class="w"> </span><span class="nn">here</span>
  <span class="o">-</span><span class="n">p</span> <span class="n">CLK_PREFIX</span><span class="p">,</span> <span class="o">--</span><span class="n">clk_prefix</span> <span class="n">CLK_PREFIX</span>
                        <span class="n">Prefix</span> <span class="n">of</span> <span class="n">the</span> <span class="n">clock</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">decoding</span> <span class="ow">is</span> <span class="n">done</span> <span class="p">[</span><span class="n">currently</span> <span class="n">ignored</span><span class="p">],</span> <span class="n">appends</span> <span class="n">_clk</span>
</pre></div>
</div>
<section id="the-workflow-of-newad">
<h3>The workflow of newad<a class="headerlink" href="#the-workflow-of-newad" title="Permalink to this heading"></a></h3>
<p>The main input to newad is essentially two arguments: the top Verilog file
to start the parser, and the list of directories where modules can be found.</p>
<p>newad starts by parsing the top file, and then starts going deeper into the
hierarchy. There are two main processes happening during this traverse:</p>
<p>1) Looking for input/output ports labeled <code class="docutils literal notranslate"><span class="pre">external</span></code>. These will turn into
software-settable registers. Some of its properties are deduced from the
native Verilog syntax: bit width, signed or not.  Additional options can be
set by more magic comments; see below.</p>
<p>The following Verilog snippet shows a 12-bit register defined as <code class="docutils literal notranslate"><span class="pre">external</span></code>.</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">phase_step</span><span class="p">,</span><span class="w"> </span><span class="c1">// external</span>
</pre></div>
</div>
<p>2) Looking for Verilog module instantiations marked <code class="docutils literal notranslate"><span class="pre">auto</span></code> (short for automatic),
for which newad needs to generate port assignments. When such an instantiation
is found, newad recurses to look deeper into the hierarchy.</p>
<p>The following Verilog snippet shows how an instantiated Verilog module is
marked <code class="docutils literal notranslate"><span class="pre">auto</span></code> by a developer:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">pair_couple</span><span class="w"> </span><span class="n">drive_couple</span><span class="w"> </span><span class="c1">// auto</span>
<span class="w">        </span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">iq</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">drive</span><span class="p">(</span><span class="n">prompt_drive</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">lo_phase</span><span class="p">(</span><span class="n">lo_phase_d</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">pair</span><span class="p">(</span><span class="n">fwd_ref</span><span class="p">),</span>
<span class="w">        </span><span class="no">`AUTOMATIC_drive_couple</span>
<span class="p">);</span>
</pre></div>
</div>
<p>In this example, software-settable ports found within drive_couple will
get filled in using the machine-generated macro <code class="docutils literal notranslate"><span class="pre">AUTOMATIC_drive_couple</span></code>.
These ports will be automatically propagated outwards to the bus controller
and decoder.</p>
<section id="register-attributes">
<h4>Register Attributes<a class="headerlink" href="#register-attributes" title="Permalink to this heading"></a></h4>
<p>Each port defined as <code class="docutils literal notranslate"><span class="pre">external</span></code> using the comment of Verilog will end up as a
software-settable register with an automatically-assigned address.  Behavior
of this port can be modified by adding more attributes in the Verilog source
file:</p>
<ul class="simple">
<li><p>single-cycle: the port will only stay high (asserted) for a single cycle
when written.  Maps nicely to operations like “clear” and “trigger”, where
no state is held in the register.</p></li>
<li><p>we-strobe: reserved for special cases where the register semantics requires
access to the write-enable signal <em>plus</em> the data bus, like pushing into a FIFO.
Implementing that behavior, given the write-enable strobe, is still the job of
the HDL program.</p></li>
</ul>
</section>
</section>
<section id="verilog-header-generation">
<h3>Verilog Header Generation<a class="headerlink" href="#verilog-header-generation" title="Permalink to this heading"></a></h3>
<p>When used with <code class="docutils literal notranslate"><span class="pre">-a</span></code> argument, newad creates a Verilog header containing the
address map for given top level object. This file will have the name
<code class="docutils literal notranslate"><span class="pre">addr_map_&lt;module_name&gt;.vh</span></code>. Inside the file, newad will place all address
decoding for each register.</p>
<p>The following is an example of a decoded register address macro definition.</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="cp">`define ADDR_HIT_digitizer_dsp_real_sim_mux_shell_0_dsp_ff_driver_mem (lb4_addr[0][`LB_HI:11]==4096) </span><span class="c1">// digitizer_dsp bitwidth: 11, base_addr: 8388608</span>
</pre></div>
</div>
<p>When used with <code class="docutils literal notranslate"><span class="pre">-r</span></code> argument, newad creates an address map in <code class="docutils literal notranslate"><span class="pre">.json</span></code> format.</p>
</section>
<section id="managing-clock-domains">
<h3>Managing clock domains<a class="headerlink" href="#managing-clock-domains" title="Permalink to this heading"></a></h3>
<p>By default, registers are set in the <code class="docutils literal notranslate"><span class="pre">lb_clk</span></code> domain in the top-level bus
controller module.  There are two provisions to override that.</p>
<p>1) In an instantiation, the default clock domain for ports for that instance
can be set.  Example:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">prc_dsp</span><span class="w"> </span><span class="n">prc_dsp</span><span class="w"> </span><span class="c1">// auto clk1x</span>
<span class="w">        </span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">adc_clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">qmode</span><span class="p">(</span><span class="n">qmode</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span><span class="w"> </span><span class="p">.</span><span class="n">adc_data</span><span class="p">(</span><span class="n">adc_data</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">iq_result1</span><span class="p">(</span><span class="n">iq_cav01</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">iq_result2</span><span class="p">(</span><span class="n">iq_cav23</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">qmode_out</span><span class="p">(</span><span class="n">qmode_out</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">cosd</span><span class="p">(</span><span class="n">cosa</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">sind</span><span class="p">(</span><span class="n">sina</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">phase_zero</span><span class="p">(</span><span class="n">phase_zero</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">fwd_in</span><span class="p">(</span><span class="n">fwd_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rev_in</span><span class="p">(</span><span class="n">rev_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">phs_avg_sum</span><span class="p">(</span><span class="n">phs_avg_sum</span><span class="p">),</span>
<span class="w">        </span><span class="no">`AUTOMATIC_prc_dsp</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Registers in the prc_dsp module will be created in the clk1x_clk domain
(happens to be equivalent to adc_clk).</p>
<p>2) Within a list of ports, the clock domain can be set in a sticky manner
with comments of the form <code class="docutils literal notranslate"><span class="pre">newad-force</span> <span class="pre">foo</span> <span class="pre">domain</span></code>.  Example:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// newad-force lb domain</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">trace_reset_we</span><span class="p">,</span><span class="w">  </span><span class="c1">// external we-strobe</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">trace_ack</span><span class="p">,</span><span class="w">  </span><span class="c1">// -- external single-cycle</span>
<span class="c1">// newad-force clk1x domain</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">trace_reset</span><span class="p">,</span><span class="w">  </span><span class="c1">// -- external single-cycle</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">13</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">cic_period</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">trace_keep</span><span class="p">,</span><span class="w"> </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">cic_shift</span><span class="p">,</span><span class="w"> </span><span class="c1">// external</span>
<span class="c1">// newad-force lb domain</span>
<span class="k">input</span><span class="w"> </span><span class="n">start_fdbk_dac_enable</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="n">buf_trig</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="c1">// newad-force clk2x domain</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">amplitude</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ddsa_phstep_h</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ddsa_phstep_l</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
<span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ddsa_modulo</span><span class="p">,</span><span class="w">  </span><span class="c1">// external</span>
</pre></div>
</div>
<p>The result will include <code class="docutils literal notranslate"><span class="pre">cic_period</span></code> in the <code class="docutils literal notranslate"><span class="pre">clk1x_clk</span></code> domain, and <code class="docutils literal notranslate"><span class="pre">buf_trig</span></code>
in the <code class="docutils literal notranslate"><span class="pre">lb_clk</span></code> domain. The hope is that option (1) will cover most use cases.</p>
<p>Note also in this example that the trace_ack and trace_reset ports will <em>not</em>
be managed by newad.  The extra <code class="docutils literal notranslate"><span class="pre">--</span></code> intentionally disables the pattern-match
for the <code class="docutils literal notranslate"><span class="pre">external</span></code> keyword.</p>
<p>You are encouraged to occasionally cross-check the register decoder produced
by newad with its <code class="docutils literal notranslate"><span class="pre">-o</span></code> flag, typically named <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;_auto.vh</span></code>, to make
sure clock domains and other behavior are emitted as intended.  Those files
can be long, but should be legible to Verilog programmers.  They even have
helpful comments at the beginning showing how newad has traversed the Verilog
hierarchy.</p>
<p>It is the responsibility of the bus controller to create local busses in each
of the clock domains needed by its submodules.</p>
</section>
<section id="register-names-and-uniqueness">
<h3>Register names and uniqueness<a class="headerlink" href="#register-names-and-uniqueness" title="Permalink to this heading"></a></h3>
<p>Software-visible register names are created based on the instance hierarchy.
For example, <code class="docutils literal notranslate"><span class="pre">ssa_stim_ampstep</span></code> is a name generated for register <code class="docutils literal notranslate"><span class="pre">ampstep</span></code>
in module instance name <code class="docutils literal notranslate"><span class="pre">ssa_stim</span></code>.  The newad-generated json file contains
the mapping from name to (generated) address.  That json file is normally
compressed, held in FPGA memory, and made available to software.  Application
software can therefore always refer to registers by name.</p>
<p>A more exotic example is <code class="docutils literal notranslate"><span class="pre">shell_1_dsp_fdbk_core_mp_proc_sel_thresh</span></code>.  Here
the instance name hierarchy is <code class="docutils literal notranslate"><span class="pre">shell</span></code>, <code class="docutils literal notranslate"><span class="pre">dsp</span></code>, <code class="docutils literal notranslate"><span class="pre">fdbk_core</span></code>, <code class="docutils literal notranslate"><span class="pre">mp_proc</span></code>, the
register name is <code class="docutils literal notranslate"><span class="pre">sel_thresh</span></code>, and the extra <code class="docutils literal notranslate"><span class="pre">1</span></code> comes from <code class="docutils literal notranslate"><span class="pre">shell</span></code> being
created in a Verilog generate loop.  The (abbreviated) syntax for that example
is</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">genvar</span><span class="w"> </span><span class="n">c_n</span><span class="p">;</span>
<span class="k">generate</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c_n</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">c_n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">2</span><span class="p">;</span><span class="w"> </span><span class="n">c_n</span><span class="o">=</span><span class="n">c_n</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="o">:</span><span class="w"> </span><span class="n">cryomodule_cavity</span>
<span class="w">    </span><span class="n">llrf_shell</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="c1">// auto(c_n,2) lb4[c_n]</span>
<span class="w">        </span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">adc_clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="no">`AUTOMATIC_shell</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">end</span><span class="w"> </span><span class="k">endgenerate</span>
</pre></div>
</div>
</section>
<section id="additional-resources">
<h3>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://gitlab.lbl.gov/hdl-libraries/bedrock/-/wikis/home/Newad-HOWTO">https://gitlab.lbl.gov/hdl-libraries/bedrock/-/wikis/home/Newad-HOWTO</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="makefile_md.html" class="btn btn-neutral float-left" title="build-tools makefile" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../dsp/README_md.html" class="btn btn-neutral float-right" title="dsp README" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, LBNL ATG.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>