
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>build-tools makefile &#8212; Bedrock  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="dsp README" href="../dsp/README_md.html" />
    <link rel="prev" title="zest README" href="../board_support/zest/README_md.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This documentation is a work in progress.
Expect to see errors and unfinished things.</p>
</div>
<section id="build-tools-makefile">
<span id="makefile"></span><h1>build-tools makefile<a class="headerlink" href="#build-tools-makefile" title="Permalink to this heading">¶</a></h1>
<section id="makefiles">
<h2>Makefiles<a class="headerlink" href="#makefiles" title="Permalink to this heading">¶</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h3>
<p>The Unix “make” program and its associated Makefiles are old,
dating to around 1976.
It’s four decades later, and many of today’s practical Makefiles,
including our own, seem enormously complicated.
It helps to see how they are built up from simpler ideas.</p>
<p>The way we use Makefiles for testing HDL and building artifacts is
slightly different from traditional pure-software projects,
but everything is still based on the same original concepts.</p>
<p>There are worse places to start learning about Makefiles than
<a class="reference external" href="https://en.wikipedia.org/wiki/Makefile">Wikipedia</a>.
Quoting that article, a Makefile consists of “rules” in the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="p">:</span> <span class="n">dependencies</span>
    <span class="n">system</span> <span class="n">command</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives the system command(s) needed to “make” target, whenever
any of the dependency files change.  Note that the line with system
command(s) on it must start with a tab character.</p>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h3>
<p>Our code base is based in large part on test benches written in Verilog
and simulated using Icarus Verilog, so that’s what our examples will cover.
For concrete discussion purposes, consider the following Makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>all: b2d_check fib_check

# self-checking
b2d_check: b2d_tb
    vvp -N b2d_tb

b2d_tb: b2d_tb.v b2d.v
    iverilog -o b2d_tb b2d_tb.v b2d.v

# check against golden output file
fib_check: fib.out fib.gold
    cmp fib.out fib.gold
    @echo PASS

fib.out: fib_tb
    vvp -N fib_tb &gt; $@

fib_tb: fib_tb.v fib.v
    iverilog -o fib_tb fib_tb.v fib.v
</pre></div>
</div>
<p>This covers two cases: one where b2d_tb is a self-checking testbench,
i.e., where execution of b2d_tb ends with $stop() on failure,
but $finish() on success.
In the other case, fib_tb creates an output file that needs to match fib.gold.</p>
<p>Normally, the make program displays each command before it is executed.
This is normally considered a good thing, because it immediately isolates the
cause of any failures that occur.
Referring to the fib_check rule above, the second command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">PASS</span>
</pre></div>
</div>
<p>is only executed if the first one succeeds.  It is not helpful to see this
command, only its result; the prefix &#64; prevents the usual echo in this case.</p>
</section>
<section id="generalization">
<h3>Generalization<a class="headerlink" href="#generalization" title="Permalink to this heading">¶</a></h3>
<p>The above Makefile can be generalized using
<a class="reference external" href="https://www.gnu.org/software/make/manual/html_node/Pattern-Rules.html">pattern rules</a>
and special Makefile macros.  Quoting Wikipedia again:</p>
<ul class="simple">
<li><p>$&#64; is a macro that refers to the target</p></li>
<li><p>$&lt; is a macro that refers to the first dependency</p></li>
<li><p>$^ is a macro that refers to all dependencies</p></li>
</ul>
<p>The previous Makefile turns into:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>%_check: %_tb
    vvp -N $&lt;

%_tb: %_tb.v
    iverilog -o $@ $^

%.out: %_tb
    vvp -N $&lt; &gt; $@

all: b2d_check fib_check

fib_check: fib.out fib.gold
    cmp $^
    @echo PASS

b2d_tb: b2d.v

fib_tb: fib.v
</pre></div>
</div>
</section>
<section id="configurability">
<h3>Configurability<a class="headerlink" href="#configurability" title="Permalink to this heading">¶</a></h3>
<p>The next layer of indirection allows command-line overrides of strings used
in the Makefile.  In particular,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>VERILOG = iverilog
%_tb: %_tb.v
        $(VERILOG) -o $@ $^
</pre></div>
</div>
<p>will allow the user to change versions of iverilog on-the-fly, without
editing the Makefile, with the command line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">VERILOG</span><span class="o">=</span><span class="n">iverilog</span><span class="o">-</span><span class="mf">0.10</span>
</pre></div>
</div>
<p>In fact, our setup normally specifies</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>VERILOG = iverilog$(ICARUS_SUFFIX)
VVP = vvp$(ICARUS_SUFFIX)
</pre></div>
</div>
<p>allowing a simple</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">ICARUS_SUFFIX</span><span class="o">=-</span><span class="mf">0.10</span>
</pre></div>
</div>
<p>to configure both the iverilog and vvp version used.</p>
</section>
<section id="makefile-includes">
<h3>Makefile includes<a class="headerlink" href="#makefile-includes" title="Permalink to this heading">¶</a></h3>
<p>Finally, we normally take all the generic definitions and put
them in a single file called top_rules.mk, which can be shared
by the individual Makefiles scattered around in various directories.
So a stripped down version of top_rules.mk looks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>VERILOG = iverilog$(ICARUS_SUFFIX)
VVP = vvp$(ICARUS_SUFFIX)
GTKWAVE = gtkwave
VFLAGS =

%_check: %_tb
    $(VVP) -N $&lt;

%_tb: %_tb.v
    $(VERILOG) $(VFLAGS) -o $@ $^

%.out: %_tb
    $(VVP) -N $&lt; &gt; $@

%.vcd: %_tb
    $(VVP) -N $&lt; +vcd

%_view: %.vcd %.gtkw
    $(GTKWAVE) $^
</pre></div>
</div>
<p>and the Makefile that references it looks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>include top_rules.mk

all: b2d_check fib_check

fib_check: fib.out fib.gold
    cmp $^
    @echo PASS

b2d_tb: b2d.v

fib_tb: fib.v

clean:
    rm -f *_tb *.vcd *.out
</pre></div>
</div>
<p>Here we have added two new features: rules to create and display
timing diagrams using gtkwave, and the traditional “clean” rule to
remove generated files.</p>
</section>
<section id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h3>
<p>What’s not covered here is dependency derivation and/or management, something
that gets increasingly complicated as the number of files involved climbs.
One approach we use is based on combining the -y and -M options to iverilog.
The -y flag will cause iverilog to
search directories for files that match unresolved module names.
The -M flag emits a list of files used, which (with some trickery)
can be converted to a dependency list for make.</p>
</section>
<section id="one-more-trick">
<h3>One more trick<a class="headerlink" href="#one-more-trick" title="Permalink to this heading">¶</a></h3>
<p>The $&#64; symbol (target name) can be used to pull in
extra configuration for commands.
The setup starts by adding an extra element to the
generic VFLAGS definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>VFLAGS = ${VFLAGS_$@}
</pre></div>
</div>
<p>That gives us a hook to let a specific testbench target add
additional parameters, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VFLAGS_b2d_tb</span> <span class="o">=</span> <span class="o">-</span><span class="n">m</span> <span class="o">./</span><span class="n">udp</span><span class="o">-</span><span class="n">vpi</span>
</pre></div>
</div>
<p>This example causes an extra module to be loaded when building b2d_tb,
without perturbing the commands to build other _tb targets.</p>
</section>
<section id="discussion">
<h3>Discussion<a class="headerlink" href="#discussion" title="Permalink to this heading">¶</a></h3>
<p>There have been <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_build_automation_software">many attempts</a>,
continuing today, to build on, enhance, or replace make.
Two in particular attempt to address the needs of an HDL environment.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ohwr.org/project/hdl-make/wikis/home">Hdlmake</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/fusesoc/">FuseSoC</a></p></li>
</ul>
<p>Our experiments with these tools have generally been frustrating.
We have used the flexibility of make to support many combinations
of target hardware and application code, as well as generated code
and self-tests.  These ideas are not normally priorities of these
more specialized tools.</p>
</section>
<section id="cross-check">
<h3>Cross-check<a class="headerlink" href="#cross-check" title="Permalink to this heading">¶</a></h3>
<p>A demo “project” using the example Makefiles above produces the
following output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iverilog</span> <span class="o">-</span><span class="n">o</span> <span class="n">b2d_tb</span> <span class="n">b2d_tb</span><span class="o">.</span><span class="n">v</span> <span class="n">b2d</span><span class="o">.</span><span class="n">v</span>
<span class="n">vvp</span> <span class="o">-</span><span class="n">N</span> <span class="n">b2d_tb</span>
<span class="n">result</span>           <span class="n">x</span> <span class="k">for</span> <span class="nb">input</span>     <span class="n">x</span>
<span class="n">result</span>         <span class="mi">123</span> <span class="k">for</span> <span class="nb">input</span>   <span class="mi">123</span>
<span class="n">result</span>         <span class="mi">123</span> <span class="k">for</span> <span class="nb">input</span>   <span class="mi">123</span>
<span class="n">result</span>       <span class="mi">60875</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">60875</span>
<span class="n">result</span>       <span class="mi">13604</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">13604</span>
<span class="n">result</span>       <span class="mi">24193</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">24193</span>
<span class="n">result</span>       <span class="mi">54793</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">54793</span>
<span class="n">result</span>       <span class="mi">22115</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">22115</span>
<span class="n">result</span>       <span class="mi">31501</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">31501</span>
<span class="n">result</span>       <span class="mi">39309</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">39309</span>
<span class="n">result</span>       <span class="mi">33893</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">33893</span>
<span class="n">result</span>       <span class="mi">21010</span> <span class="k">for</span> <span class="nb">input</span> <span class="mi">21010</span>
         <span class="mi">12</span> <span class="n">tests</span> <span class="n">passed</span>
<span class="n">PASS</span>
<span class="n">iverilog</span> <span class="o">-</span><span class="n">o</span> <span class="n">fib_tb</span> <span class="n">fib_tb</span><span class="o">.</span><span class="n">v</span> <span class="n">fib</span><span class="o">.</span><span class="n">v</span>
<span class="n">vvp</span> <span class="o">-</span><span class="n">N</span> <span class="n">fib_tb</span> <span class="o">&gt;</span> <span class="n">fib</span><span class="o">.</span><span class="n">out</span>
<span class="n">cmp</span> <span class="n">fib</span><span class="o">.</span><span class="n">out</span> <span class="n">fib</span><span class="o">.</span><span class="n">gold</span>
<span class="n">PASS</span>
</pre></div>
</div>
<p>The three Makefiles above are all equivalent, in the sense that they produce
the same output (at least when whitespace is ignored).</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Bedrock</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../general-docs.html">General Docs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../general-docs.html#docs">Docs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../badger/README_md.html">badger README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/doc/README_md.html">doc README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/mem_gate_md.html">badger mem_gate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../badger/status_md.html">badger status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/bmb7_kintex/README_md.html">bmb7_kintex README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../board_support/zest/README_md.html">zest README</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">build-tools makefile</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#makefiles">Makefiles</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dsp/README_md.html">dsp README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fpga_family/xilinx/README_md.html">xilinx README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/CONTRIBUTING_md.html">guidelines CONTRIBUTING</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/rtl_guidelines_md.html">guidelines rtl_guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/i2cbridge/README_md.html">i2cbridge README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peripheral_drivers/idelay_scanner/README_md.html">idelay_scanner README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/common/README_md.html">common README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/comms_top/README_md.html">comms_top README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/bmb7_cu/README_md.html">bmb7_cu README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/oscope/marble_family/README_md.html">marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../projects/test_marble_family/README_md.html">test_marble_family README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rtsim/README_md.html">rtsim README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/README_md.html">chitchat README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../serial_io/chitchat/chitchat_txrx_wrap_md.html">chitchat chitchat_txrx_wrap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/README_md.html">picorv32 README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/badger_lwip/README_md.html">badger_lwip README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/fv/README_md.html">fv README</a></li>
<li class="toctree-l3"><a class="reference internal" href="../soc/picorv32/test/lb_bridge/README_md.html">lb_bridge README</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bedrock-modules.html">Bedrock Modules</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../../general-docs.html">General Docs</a><ul>
      <li>Previous: <a href="../board_support/zest/README_md.html" title="previous chapter">zest README</a></li>
      <li>Next: <a href="../dsp/README_md.html" title="next chapter">dsp README</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, LBNL ATG.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/_gen_md/build-tools/makefile_md.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>